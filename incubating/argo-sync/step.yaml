kind: step-type
metadata:
  name: aperture-sci/argo-sync
  version: 1.1.0
  isPublic: false
  description: ArgoCD app sync for GitOps
  sources:
    - 'https://github.com/codefresh-io/steps/tree/master/incubating/argo-sync'
  stage: incubating
  maintainers:
    - name: Laurent Rochette
    - email: laurent.rochette@codefresh.io
  categories:
    - GitOps
  official: false
  tags: []
  icon:
    type: svg
    url: https://cdn.jsdelivr.net/gh/codefresh-io/steps/graduated/argocd-sync/argo.svg
    background: "#f4f4f4"

spec:
  arguments: |-
    {
      "definitions": {},
      "$schema": "http://json-schema.org/draft-07/schema#",
      "type": "object",
      "additionalProperties": true,
      "patterns": [],
      "required": [
        "RUNTIME",
        "APPLICATION"
      ],
      "properties": {
        "RUNTIME": {
          "type": "string",
          "description": "Name of the GitOps runtime."
        },
        "APPLICATION": {
          "type": "string",
          "description": "Name of the application to sync."
        },
        "SYNC_IMAGE": {
          "type": "string",
          "default": "franciscocodefresh/argocd_sync",
          "description": "The Sync container image registry/image for the step."
        },
        "SYNC_IMAGE_VERSION": {
          "type": "string",
          "default": "0.3.0",
          "description": "Version of the Sync image to use, Docker image tag."
        }
      }
    }
  stepsTemplate: |-
    sync:
      name: sync application
      image: '[[.Arguments.SYNC_IMAGE]]:[[.Arguments.SYNC_IMAGE_VERSION]]'
      environment:
      [[ range $key, $val := .Arguments ]]
        - '[[ $key ]]=[[ $val ]]'
      [[- end ]]
      commands:
        - |
          cd /app
          python3 run.py
    link:
      name: Add link towards app
      image: quay.io/codefresh/cli
      commands:
        - |
          cf_export annotation_CF_OUTPUT_URL="${{CF_URL}}/2.0/applications-dashboard/[[.Arguments.RUNTIME]]/[[.Arguments.RUNTIME]]/[[.Arguments.APPLICATION]]current-state/tree"
  delimiters:
    left: '[['
    right: ']]'
