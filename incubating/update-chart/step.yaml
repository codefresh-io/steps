version: '1.0'
kind: step-type
metadata:
  name: codefreshdemo/update-chart # FIXME - remove codefreshdemo
  title: Update a Helm chart
  version: 0.0.1
  isPublic: false # FIXME - update to true
  description: >-
    Update a Helm 3 chart's Chart.yaml and values.yaml files. By default, it also increments the chart's 'version'
    semver. See full explanation of Chart.yaml fields at https://helm.sh/docs/topics/charts/#the-chartyaml-file.
  sources:
    - 'https://github.com/codefresh-io/steps/tree/master/incubating/update-chart'
  stage: incubating
  maintainers:
    - name: Ted Spinks
      email: ted.spinks@codefresh.io
  categories:
    - deployment
  official: true
  tags: []
  icon:
    type: svg
    url: https://cdn.jsdelivr.net/gh/codefresh-contrib/cfstep-helmfile/helm-logo.svg
    background: "#f4f4f4"
  examples:
    - description: Update a chart dependency
      workflow:
        update_chart_dependency:
          title: Update a dependency to a new version
          type: update-chart
          working_directory: /codefresh/volume/my-umbrella-chart
          arguments:
            DEPENDENCY_NAME: 'my-subchart'
            DEPENDENCY_VERSION: '1.2.3'
            DEPENDENCY_REPOSITORY: '${{CF_CTX_CF_HELM_DEFAULT_URL}}'
    - description: Update image tag variables
      workflow:
        update_chart_dependency:
          title: Update image tag variables
          type: update-chart
          working_directory: /codefresh/volume/my-umbrella-chart
          arguments:
            VALUES_TO_UPDATE:
              - 'global.image.tags.my-web-svc=1.2.3'
              - 'global.image.tags.my-other-svc=4.5.6'
  latest: true
spec:
  arguments: |-
    {
        "definitions": {},
        "$schema": "http://json-schema.org/draft-07/schema#",
        "type": "object",
        "additionalProperties": false,
        "patterns": [],
        "required": [
            "INCREMENT_CHART_VERSION"
        ],
        "properties": {
            "INCREMENT_CHART_VERSION": {
                "type": "boolean",
                "description": "Increment the last digit of the chart's 'version' field. Default is true. If a specific 'version' is provided in FIELDS_TO_UPDATE, that will take precedence.",
                "default": true
            },
            "VALUES_TO_UPDATE": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": "List of values in values.yaml to update. Format: path.to.variable=value."
            },
            "FIELDS_TO_UPDATE": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": "List of string fields to update. Format: fieldName='new value'. Example: description='my awesome chart'. Note: updating 'version' overrides INCREMENT_CHART_VERSION."
            },
            "KEYWORDS": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": Updated 'keywords' list; Appends or overwrites existing list based on KEYWORDS_REPLACE."
            },
            "KEYWORDS_REPLACE": {
                "type": "boolean",
                "description": "'false' (default) will append to the existing list. 'true' (default) will overwrite the existing list. Default is true.",
                "default": false
            },
            "SOURCES": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": Updated chart 'sources' list; Appends or overwrites existing list based on SOURCES_REPLACE."
            },
            "SOURCES_REPLACE": {
                "type": "boolean",
                "description": "'false' (default) will append to the existing list. 'true' (default) will overwrite the existing list. Default is true.",
                "default": false
            },
            "DEPENDENCY_REPLACE": {
                "type": "boolean",
                "description": "If the specifed chart name already exists, overwrite it instead of adding a new entry. Default is true.",
                "default": true
            },
            "DEPENDENCY_NAME": {
                "type": "string",
                "description": "'name' of the chart to update in 'dependencies' list. Required when updating a dependency."
            },
            "DEPENDENCY_VERSION": {
                "type": "string",
                "description": "Updated 'version' of the dependency list entry."
            },
            "DEPENDENCY_REPOSITORY": {
                "type": "string",
                "description": "Updated 'repository' of the dependency list entry. This is a helm repo URL or alias."
            },
            "DEPENDENCY_CONDITION": {
                "type": "string",
                "description": "Updated 'condition' of the dependency list entry. This is a yaml path that resolves to a boolean, for enabling/disabling the chart."
            },
            "DEPENDENCY_TAGS": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": "Updated 'tags' list; Appends or overwrites existing list based on DEPENDENCY_TAGS_REPLACE."
            },
            "DEPENDENCY_TAGS_REPLACE": {
                "type": "boolean",
                "description": "'false' (default) will append to the existing list. 'true' (default) will overwrite the existing list. Default is true.",
                "default": false
            },
            "DEPENDENCY_IMPORT_VALUES": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": "Updated 'import-values' list; Appends or overwrites existing list based on DEPENDENCY_IMPORT_VALUES_REPLACE."
            },
            "DEPENDENCY_IMPORT_VALUES_REPLACE": {
                "type": "boolean",
                "description": "'false' (default) will append to the existing list. 'true' (default) will overwrite the existing list. Default is true.",
                "default": false
            },
            "DEPENDENCY_ALIAS": {
                "type": "string",
                "description": "Updated 'alias' of the dependency list entry. This allows having entries with duplicate chart names."
            },
            "ANNOTATIONS": {
                "type": ["string","array"],
                "items": {
                    "type": "string"
                },
                "description": Updated chart 'annotations' list. Format: myAnnotation='someValue'. Appends or overwrites existing list based on ANNOTATIONS_REPLACE."
            },
            "ANNOTATIONS_REPLACE": {
                "type": "boolean",
                "description": "'false' (default) will append to the existing list. 'true' (default) will overwrite the existing list. Default is true.",
                "default": false
            }
        }
    }
  stepsTemplate: |-
    update_chart:
      image: gtspinks/update_chart:0.0.1 # FIXME - quay.io/codefreshplugins/update_chart:0.0.1
      commands:
        - pwd
        - ls -la
        - python3 /update-chart.py
        - helm lint
      environment:
      [[ range $key, $val := .Arguments ]]
        - '[[ $key ]]=[[ $val ]]'
      [[- end ]]
  delimiters:
    left: '[['
    right: ']]'
